name: Build .NET SDK

on: [workflow_dispatch, pull_request]

env:
  PACKAGESDIR: ${{ github.workspace }}/packages
  DOWNLOADDIR: ${{ github.workspace }}/downloads
  OUTPUTDIR: ${{ github.workspace }}/output
  ROOTFS_DIR: "/crossrootfs/riscv64"
  VERSION: "v8.0.0"

jobs:
  run:
    runs-on: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-22.04-cross-riscv64
    name: Build

    steps:
    - name: Clone repository
      run: |
        git clone --depth 1 -b ${{VERSION}} https://github.com/dotnet/runtime
        git clone --depth 1 -b ${{VERSION}} https://github.com/dotnet/sdk
        git clone --depth 1 -b ${{VERSION}} https://github.com/dotnet/aspnetcore
        git clone --depth 1 -b ${{VERSION}} https://github.com/dotnet/installer

    - name: Build runtime
      run: |
        cd runtime
        ./build.sh --ci -c Release --cross --arch riscv64
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/Microsoft.NETCore.App.Host.linux-ppc64le.*.nupkg ${PACKAGESDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/Microsoft.NETCore.App.Runtime.linux-ppc64le.*.nupkg ${PACKAGESDIR}
        mkdir -p ${DOWNLOADDIR}/Runtime/${RUNTIME_VERSION}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/dotnet-runtime-*-linux-ppc64le.tar.gz ${DOWNLOADDIR}/Runtime/${RUNTIME_VERSION}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/dotnet-runtime-*-linux-ppc64le.tar.gz ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/Microsoft.NETCore.App.Host.linux-ppc64le.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/Microsoft.NETCore.App.Runtime.linux-ppc64le.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/runtime.linux-ppc64le.Microsoft.NETCore.DotNetHost.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/runtime.linux-ppc64le.Microsoft.NETCore.DotNetHostPolicy.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/runtime.linux-ppc64le.Microsoft.NETCore.DotNetHostResolver.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/runtime.linux-ppc64le.Microsoft.NETCore.ILAsm.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/${RUNTIME_CONF}/Shipping/runtime.linux-ppc64le.Microsoft.NETCore.ILDAsm.*.nupkg ${OUTPUTDIR}

name: Build .NET SDK

on: [workflow_dispatch, pull_request]

jobs:
  run:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-22.04-cross-riscv64
      env:
        PACKAGESDIR: ${{ github.workspace }}/packages
        DOWNLOADDIR: ${{ github.workspace }}/downloads
        OUTPUTDIR: ${{ github.workspace }}/output
        RUNTIME_VERSION: 8.0.0-rtm.23531.3
        SDK_VERSION: 8.0.100-rtm.23551.6
        ROOTFS_DIR: "/crossrootfs/riscv64"

    steps:
    - name: Clone repositories
      run: |
        git clone --depth 1 -b v8.0.0 https://github.com/dotnet/runtime
        git clone --depth 1 -b v8.0.0 https://github.com/dotnet/aspnetcore
        git clone --depth 1 -b v8.0.100 https://github.com/dotnet/sdk
        git clone --depth 1 -b v8.0.100 https://github.com/dotnet/installer

    - name: Build runtime
      run: |
        mkdir -p ${PACKAGESDIR}
        mkdir -p ${DOWNLOADDIR}
        mkdir -p ${OUTPUTDIR}

        cd runtime
        ./build.sh --ci -c Release --cross --arch riscv64 /p:OfficialBuildId=$(version_build_id ${RUNTIME_VERSION})
        cp artifacts/packages/Release/Shipping/Microsoft.NETCore.App.Host.linux-riscv64.*.nupkg ${PACKAGESDIR}
        cp artifacts/packages/Release/Shipping/Microsoft.NETCore.App.Runtime.linux-riscv64.*.nupkg ${PACKAGESDIR}
        mkdir -p ${DOWNLOADDIR}/Runtime/${RUNTIME_VERSION}
        cp artifacts/packages/Release/Shipping/dotnet-runtime-*-linux-riscv64.tar.gz ${DOWNLOADDIR}/Runtime/${RUNTIME_VERSION}
        cp artifacts/packages/Release/Shipping/dotnet-runtime-*-linux-riscv64.tar.gz ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/Microsoft.NETCore.App.Host.linux-riscv64.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/Microsoft.NETCore.App.Runtime.linux-riscv64.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/runtime.linux-riscv64.Microsoft.NETCore.DotNetHost.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/runtime.linux-riscv64.Microsoft.NETCore.DotNetHostPolicy.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/runtime.linux-riscv64.Microsoft.NETCore.DotNetHostResolver.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/runtime.linux-riscv64.Microsoft.NETCore.ILAsm.*.nupkg ${OUTPUTDIR}
        cp artifacts/packages/Release/Shipping/runtime.linux-riscv64.Microsoft.NETCore.ILDAsm.*.nupkg ${OUTPUTDIR}

    - name: Build SDK
      run: |
        cd sdk
        ./build.sh --pack --ci -c Release /p:Architecture=riscv64 /p:OfficialBuildId=$(version_build_id ${SDK_VERSION})
        mkdir -p ${DOWNLOADDIR}/Sdk/${SDK_VERSION}
        cp artifacts/packages/Release/NonShipping/dotnet-toolset-internal-*.zip ${DOWNLOADDIR}/Sdk/${SDK_VERSION}/dotnet-toolset-internal-${SDK_VERSION}.zip
        cp artifacts/packages/Release/Shipping/Microsoft.DotNet.Common.*.nupkg ${PACKAGESDIR}

    # - name: Build aspnetcore
    #   run: |
    #     cd aspnetcore
    #     ./eng/build.sh --pack --ci -c Release -arch riscv64 -- /p:PublicBaseURL=file://${DOWNLOADDIR}/


    #     cp artifacts/packages/Release/Shipping/Microsoft.AspNetCore.App.Runtime.linux-riscv64.*.nupkg ${PACKAGESDIR}
    #     mkdir -p ${DOWNLOADDIR}/aspnetcore/Runtime/${SW_VERSION}
    #     cp artifacts/installers/Release/aspnetcore-runtime-internal-*-linux-riscv64.tar.gz ${DOWNLOADDIR}/aspnetcore/Runtime/${SW_VERSION}
    #     cp artifacts/installers/Release/aspnetcore_base_runtime.version ${DOWNLOADDIR}/aspnetcore/Runtime/${SW_VERSION}
    #     cp artifacts/packages/Release/Shipping/Microsoft.AspNetCore.App.Runtime.linux-riscv64.*.nupkg ${OUTPUTDIR}
    #     cp artifacts/packages/Release/Shipping/Microsoft.DotNet.Web.*.nupkg ${PACKAGESDIR}

    - name: Build installer
      run: |
        cd installer
        ./build.sh --ci -c Release -a riscv64 /p:HostRid=linux-x64 -- /p:PublicBaseURL=file://${DOWNLOADDIR}/
        cp artifacts/packages/Release/Shipping/dotnet-sdk-*-linux-riscv64.tar.gz ${OUTPUTDIR}

    - name: Upload .NET
      uses: actions/upload-artifact@v2
      with:
        name: dotnet-sdk-linux-riscv64
        path: ${OUTPUTDIR}/dotnet-sdk-*-linux-riscv64.tar.gz
